SSLSessionCache none
ServerSignature Off
ServerTokens Prod
<VirtualHost *:8000>

        ServerName 172.25.0.6
        DocumentRoot /var/www/html/frontend
        SSLEngine on
        SSLCertificateFile /etc/ssl/certs/sesame-it-frontend-selfsigned.crt
        SSLCertificateKeyFile /etc/ssl/certs/sesame-it-frontend-selfsigned.key

        # ==============================
        # MaxMindDB Setup
        # ==============================

        <IfModule mod_maxminddb.c>
            MaxMindDBEnable On
            MaxMindDBFile DB /usr/share/GeoIP/GeoLite2-Country.mmdb
            MaxMindDBEnv MM_COUNTRY_CODE DB/country/iso_code
        </IfModule>

        <IfModule !mod_maxminddb.c>
            ErrorLog ${APACHE_LOG_DIR}/error.log
            CustomLog ${APACHE_LOG_DIR}/access.log combined
            ErrorDocument 403 "MaxMindDB is not enabled. Access denied."
            Require all denied
        </IfModule>

        # Include IP & Country restrictions
        IncludeOptional /usr/share/GeoIP/allowed-countries.conf
        IncludeOptional /usr/share/GeoIP/allowed-ips.conf

        # ==============================
        # Global Access Control
        # ==============================
        <Directory /var/www/html>
            Require all denied
            Require env AllowedCountry
            Require env AllowedIP
        </Directory>

        <IfModule mod_proxy.c>
                <IfModule mod_proxy_http.c>
                        ProxyPreserveHost On
                        SSLProxyEngine on
                        SSLProxyVerify none
                        SSLProxyCheckPeerCN off
                        SSLProxyCheckPeerName off
                        SSLProxyCheckPeerExpire off
                        SSLProxyProtocol all -SSLv3 -TLSv1 -TLSv1.1
                        SSLProxyCipherSuite HIGH:!aNULL:!MD5
                        #SSLProxyCACertificateFile /usr/local/share/ca-certificates/sesame-it-gateway-selfsigned.crt
                        ProxyPass /api https://172.25.0.7:8002
                        ProxyPassReverse /api https://172.25.0.7:8002
                </IfModule>

                <IfModule !mod_proxy_http.c>
                        ErrorLog ${APACHE_LOG_DIR}/error.log
                        CustomLog ${APACHE_LOG_DIR}/access.log combined
                        RedirectMatch 403 ^/api
                        ErrorDocument 403 "Proxying is not enabled. Please contact the server admin">
                </IfModule>
        </IfModule>

        <Directory /var/www/html/frontend>
                DirectoryIndex index.html

                Options Indexes FollowSymLinks MultiViews
                AllowOverride All
                Require all denied
                Require env AllowedCountry
                Require env AllowedIP

                <IfModule mod_rewrite.c>
                        RewriteEngine On
                        RewriteCond %{REQUEST_FILENAME} !-f
                        RewriteCond %{REQUEST_FILENAME} !-d
                        RewriteRule ^ index.html [L]
                </IfModule>
        </Directory>

        ErrorLog ${APACHE_LOG_DIR}/front_error.log
        CustomLog ${APACHE_LOG_DIR}/front_access.log combined

</VirtualHost>
